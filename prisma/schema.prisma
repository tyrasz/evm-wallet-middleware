// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Wallet {
  id        String   @id @default(uuid())
  address   String   @unique
  // Encrypted private key (stored as base64 or hex string)
  encryptedPrivateKey String
  // Initialization vector for encryption (needed for AES-GCM)
  iv        String
  // Optional label for the wallet
  label     String?
  // Chain type (e.g., "EVM") - allows future expansion
  chainType String   @default("EVM")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
  tokens       WalletToken[]
}

model Token {
  id        String   @id @default(uuid())
  address   String   @unique
  symbol    String
  decimals  Int
  chainId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallets   WalletToken[]
}

model WalletToken {
  walletId  String
  tokenId   String
  wallet    Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  token     Token  @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@id([walletId, tokenId])
}

model ApiKey {
  id          String   @id @default(uuid())
  keyHash     String   @unique
  prefix      String
  role        String   // ADMIN, OPERATOR
  description String?
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime?
}

model Transaction {
  id        String   @id @default(uuid())
  hash      String?  @unique // Nullable because we might create the record before broadcasting
  from      String
  to        String
  value     String   // Stored as string to handle large integers (Wei)
  data      String?
  chainId   Int
  status    String   // PENDING, MINED, FAILED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  walletId  String
  wallet    Wallet   @relation(fields: [walletId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  actor     String   // API Key Prefix or User ID
  metadata  String?  // JSON stringified
  ipAddress String?
  userAgent String?
  status    String   // 'SUCCESS', 'FAILURE'
  createdAt DateTime @default(now())
}

model Policy {
  id        String   @id @default(uuid())
  type      String   // TRANSACTION_LIMIT, WHITELIST
  config    String   // JSON string
  scope     String   // GLOBAL, WALLET
  entityId  String?  // Optional wallet UUID
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Webhook {
  id        String   @id @default(uuid())
  url       String
  events    String   // JSON stringified array of events
  secret    String?  // Optional secret
  createdAt DateTime @default(now())
}

model Proposal {
  id        String   @id @default(uuid())
  type      String   // TRANSACTION, POLICY_UPDATE, etc.
  data      String   // JSON payload
  status    String   // PENDING, APPROVED, REJECTED, EXECUTED, FAILED
  creator   String   // API Key Prefix
  approver  String?  // API Key Prefix
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
